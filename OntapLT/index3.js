import { promises as fs } from 'fs'; // Module để đọc file cục bộ
import axios from 'axios'; // Module để tải file từ URL
import Papa from 'papaparse'; // Thư viện phân tích CSV

//file csv có cấu query như sau:select  * from subject right join test on subject.id = test.IDSubject left join test_question on test.id = test_question.IDTest where subject.IDrank=1 limit 100000

const arraySubjects = [
    {
        id: 1,
        name: 'Pháp luật giao thông đường bộ',
        numberofquestion: 20,
        threshold: 10,
        IDrank: 1,
        nameEx: 'PLGTDB',
        showsubject: true,
        timeFinish: 11,
    },
    {
        id: 2,
        name: 'Cấu tạo và sửa chữa thông thường',
        numberofquestion: 10,
        threshold: 5,
        IDrank: 1,
        nameEx: 'CauTao',
        showsubject: true,
        timeFinish: 6,
    },
    {
        id: 3,
        name: 'Nghiệp vụ vận tải',
        numberofquestion: 10,
        threshold: 5,
        IDrank: 1,
        nameEx: 'NVVT',
        showsubject: true,
        timeFinish: 6,
    },
    {
        id: 4,
        name: 'Đạo đức người lái xe và văn hóa giao thông',
        numberofquestion: 10,
        threshold: 5,
        IDrank: 1,
        nameEx: 'DaoDuc',
        showsubject: true,
        timeFinish: 6,
    },
    {
        id: 5,
        name: 'Kỹ thuật lái xe',
        numberofquestion: 10,
        threshold: 5,
        IDrank: 1,
        nameEx: 'KTLX',
        showsubject: true,
        timeFinish: 6,
    },
];

const questionsByNumber = {
    1: { id: 601, number: 1, answer: 2 },
    2: { id: 602, number: 2, answer: 2 },
    3: { id: 603, number: 3, answer: 1 },
    4: { id: 604, number: 4, answer: 3 },
    5: { id: 605, number: 5, answer: 1 },
    6: { id: 606, number: 6, answer: 1 },
    7: { id: 607, number: 7, answer: 4 },
    8: { id: 608, number: 8, answer: 2 },
    9: { id: 609, number: 9, answer: 1 },
    10: { id: 610, number: 10, answer: 3 },
    11: { id: 611, number: 11, answer: 3 },
    12: { id: 612, number: 12, answer: 3 },
    13: { id: 613, number: 13, answer: 2 },
    14: { id: 614, number: 14, answer: 2 },
    15: { id: 615, number: 15, answer: 2 },
    16: { id: 616, number: 16, answer: 4 },
    17: { id: 617, number: 17, answer: 3 },
    18: { id: 618, number: 18, answer: 2 },
    19: { id: 619, number: 19, answer: 3 },
    20: { id: 620, number: 20, answer: 1 },
    21: { id: 621, number: 21, answer: 1 },
    22: { id: 622, number: 22, answer: 1 },
    23: { id: 623, number: 23, answer: 2 },
    24: { id: 624, number: 24, answer: 1 },
    25: { id: 625, number: 25, answer: 2 },
    26: { id: 626, number: 26, answer: 3 },
    27: { id: 627, number: 27, answer: 3 },
    28: { id: 628, number: 28, answer: 2 },
    29: { id: 629, number: 29, answer: 1 },
    30: { id: 630, number: 30, answer: 3 },
    31: { id: 631, number: 31, answer: 2 },
    32: { id: 632, number: 32, answer: 4 },
    33: { id: 633, number: 33, answer: 2 },
    34: { id: 634, number: 34, answer: 2 },
    35: { id: 635, number: 35, answer: 3 },
    36: { id: 636, number: 36, answer: 1 },
    37: { id: 637, number: 37, answer: 2 },
    38: { id: 638, number: 38, answer: 4 },
    39: { id: 639, number: 39, answer: 1 },
    40: { id: 640, number: 40, answer: 1 },
    41: { id: 641, number: 41, answer: 1 },
    42: { id: 642, number: 42, answer: 4 },
    43: { id: 643, number: 43, answer: 2 },
    44: { id: 644, number: 44, answer: 4 },
    45: { id: 645, number: 45, answer: 4 },
    46: { id: 646, number: 46, answer: 3 },
    47: { id: 647, number: 47, answer: 1 },
    48: { id: 648, number: 48, answer: 2 },
    49: { id: 649, number: 49, answer: 4 },
    50: { id: 650, number: 50, answer: 3 },
    51: { id: 651, number: 51, answer: 2 },
    52: { id: 652, number: 52, answer: 3 },
    53: { id: 653, number: 53, answer: 1 },
    54: { id: 654, number: 54, answer: 2 },
    55: { id: 655, number: 55, answer: 2 },
    56: { id: 656, number: 56, answer: 3 },
    57: { id: 657, number: 57, answer: 1 },
    58: { id: 658, number: 58, answer: 2 },
    59: { id: 659, number: 59, answer: 2 },
    60: { id: 660, number: 60, answer: 2 },
    61: { id: 661, number: 61, answer: 3 },
    62: { id: 662, number: 62, answer: 2 },
    63: { id: 663, number: 63, answer: 1 },
    64: { id: 664, number: 64, answer: 1 },
    65: { id: 665, number: 65, answer: 2 },
    66: { id: 666, number: 66, answer: 2 },
    67: { id: 667, number: 67, answer: 3 },
    68: { id: 668, number: 68, answer: 1 },
    69: { id: 669, number: 69, answer: 2 },
    70: { id: 670, number: 70, answer: 2 },
    71: { id: 671, number: 71, answer: 1 },
    72: { id: 672, number: 72, answer: 2 },
    73: { id: 673, number: 73, answer: 1 },
    74: { id: 674, number: 74, answer: 3 },
    75: { id: 675, number: 75, answer: 4 },
    76: { id: 676, number: 76, answer: 4 },
    77: { id: 677, number: 77, answer: 1 },
    78: { id: 678, number: 78, answer: 3 },
    79: { id: 679, number: 79, answer: 3 },
    80: { id: 680, number: 80, answer: 3 },
    81: { id: 681, number: 81, answer: 3 },
    82: { id: 682, number: 82, answer: 4 },
    83: { id: 683, number: 83, answer: 3 },
    84: { id: 684, number: 84, answer: 1 },
    85: { id: 685, number: 85, answer: 2 },
    86: { id: 686, number: 86, answer: 2 },
    87: { id: 687, number: 87, answer: 2 },
    88: { id: 688, number: 88, answer: 4 },
    89: { id: 689, number: 89, answer: 2 },
    90: { id: 690, number: 90, answer: 1 },
    91: { id: 691, number: 91, answer: 1 },
    92: { id: 692, number: 92, answer: 2 },
    93: { id: 693, number: 93, answer: 3 },
    94: { id: 694, number: 94, answer: 3 },
    95: { id: 695, number: 95, answer: 4 },
    96: { id: 696, number: 96, answer: 2 },
    97: { id: 697, number: 97, answer: 3 },
    98: { id: 698, number: 98, answer: 1 },
    99: { id: 699, number: 99, answer: 3 },
    100: { id: 700, number: 100, answer: 1 },
    101: { id: 701, number: 101, answer: 1 },
    102: { id: 702, number: 102, answer: 2 },
    103: { id: 703, number: 103, answer: 1 },
    104: { id: 704, number: 104, answer: 1 },
    105: { id: 705, number: 105, answer: 1 },
    106: { id: 706, number: 106, answer: 3 },
    107: { id: 707, number: 107, answer: 1 },
    108: { id: 708, number: 108, answer: 1 },
    109: { id: 709, number: 109, answer: 1 },
    110: { id: 710, number: 110, answer: 3 },
    111: { id: 711, number: 111, answer: 1 },
    112: { id: 712, number: 112, answer: 2 },
    113: { id: 713, number: 113, answer: 4 },
    114: { id: 714, number: 114, answer: 2 },
    115: { id: 715, number: 115, answer: 1 },
    116: { id: 716, number: 116, answer: 2 },
    117: { id: 717, number: 117, answer: 4 },
    118: { id: 718, number: 118, answer: 2 },
    119: { id: 719, number: 119, answer: 3 },
    120: { id: 720, number: 120, answer: 1 },
    121: { id: 721, number: 121, answer: 1 },
    122: { id: 722, number: 122, answer: 1 },
    123: { id: 723, number: 123, answer: 2 },
    124: { id: 724, number: 124, answer: 2 },
    125: { id: 725, number: 125, answer: 1 },
    126: { id: 726, number: 126, answer: 2 },
    127: { id: 727, number: 127, answer: 1 },
    128: { id: 728, number: 128, answer: 1 },
    129: { id: 729, number: 129, answer: 2 },
    130: { id: 730, number: 130, answer: 2 },
    131: { id: 731, number: 131, answer: 1 },
    132: { id: 732, number: 132, answer: 1 },
    133: { id: 733, number: 133, answer: 3 },
    134: { id: 734, number: 134, answer: 2 },
    135: { id: 735, number: 135, answer: 3 },
    136: { id: 736, number: 136, answer: 3 },
    137: { id: 737, number: 137, answer: 2 },
    138: { id: 738, number: 138, answer: 3 },
    139: { id: 739, number: 139, answer: 3 },
    140: { id: 740, number: 140, answer: 3 },
    141: { id: 741, number: 141, answer: 1 },
    142: { id: 742, number: 142, answer: 3 },
    143: { id: 743, number: 143, answer: 3 },
    144: { id: 744, number: 144, answer: 4 },
    145: { id: 745, number: 145, answer: 1 },
    146: { id: 746, number: 146, answer: 3 },
    147: { id: 747, number: 147, answer: 3 },
    148: { id: 748, number: 148, answer: 2 },
    149: { id: 749, number: 149, answer: 3 },
    150: { id: 750, number: 150, answer: 4 },
    151: { id: 751, number: 151, answer: 1 },
    152: { id: 752, number: 152, answer: 2 },
    153: { id: 753, number: 153, answer: 3 },
    154: { id: 754, number: 154, answer: 3 },
    155: { id: 755, number: 155, answer: 3 },
    156: { id: 756, number: 156, answer: 1 },
    157: { id: 757, number: 157, answer: 1 },
    158: { id: 758, number: 158, answer: 4 },
    159: { id: 759, number: 159, answer: 3 },
    160: { id: 760, number: 160, answer: 2 },
    161: { id: 761, number: 161, answer: 3 },
    162: { id: 762, number: 162, answer: 1 },
    163: { id: 763, number: 163, answer: 4 },
    164: { id: 764, number: 164, answer: 2 },
    165: { id: 765, number: 165, answer: 4 },
    166: { id: 766, number: 166, answer: 2 },
    167: { id: 767, number: 167, answer: 1 },
    168: { id: 768, number: 168, answer: 3 },
    169: { id: 769, number: 169, answer: 3 },
    170: { id: 770, number: 170, answer: 1 },
    171: { id: 771, number: 171, answer: 2 },
    172: { id: 772, number: 172, answer: 4 },
    173: { id: 773, number: 173, answer: 4 },
    174: { id: 774, number: 174, answer: 2 },
    175: { id: 775, number: 175, answer: 1 },
    176: { id: 776, number: 176, answer: 1 },
    177: { id: 777, number: 177, answer: 1 },
    178: { id: 778, number: 178, answer: 2 },
    179: { id: 779, number: 179, answer: 1 },
    180: { id: 780, number: 180, answer: 1 },
    181: { id: 781, number: 181, answer: 1 },
    182: { id: 782, number: 182, answer: 3 },
    183: { id: 783, number: 183, answer: 3 },
    184: { id: 784, number: 184, answer: 3 },
    185: { id: 785, number: 185, answer: 1 },
    186: { id: 786, number: 186, answer: 1 },
    187: { id: 787, number: 187, answer: 3 },
    188: { id: 788, number: 188, answer: 2 },
    189: { id: 789, number: 189, answer: 1 },
    190: { id: 790, number: 190, answer: 1 },
    191: { id: 791, number: 191, answer: 3 },
    192: { id: 792, number: 192, answer: 2 },
    193: { id: 793, number: 193, answer: 3 },
    194: { id: 794, number: 194, answer: 1 },
    195: { id: 795, number: 195, answer: 3 },
    196: { id: 796, number: 196, answer: 4 },
    197: { id: 797, number: 197, answer: 3 },
    198: { id: 798, number: 198, answer: 2 },
    199: { id: 799, number: 199, answer: 2 },
    200: { id: 800, number: 200, answer: 2 },
    201: { id: 801, number: 201, answer: 3 },
    202: { id: 802, number: 202, answer: 2 },
    203: { id: 803, number: 203, answer: 1 },
    204: { id: 804, number: 204, answer: 1 },
    205: { id: 805, number: 205, answer: 3 },
    206: { id: 806, number: 206, answer: 1 },
    207: { id: 807, number: 207, answer: 1 },
    208: { id: 808, number: 208, answer: 3 },
    209: { id: 809, number: 209, answer: 3 },
    210: { id: 810, number: 210, answer: 3 },
    211: { id: 811, number: 211, answer: 1 },
    212: { id: 812, number: 212, answer: 3 },
    213: { id: 813, number: 213, answer: 4 },
    214: { id: 814, number: 214, answer: 1 },
    215: { id: 815, number: 215, answer: 1 },
    216: { id: 816, number: 216, answer: 2 },
    217: { id: 817, number: 217, answer: 2 },
    218: { id: 818, number: 218, answer: 1 },
    219: { id: 819, number: 219, answer: 4 },
    220: { id: 820, number: 220, answer: 2 },
    221: { id: 821, number: 221, answer: 2 },
    222: { id: 822, number: 222, answer: 1 },
    223: { id: 823, number: 223, answer: 1 },
    224: { id: 824, number: 224, answer: 2 },
    225: { id: 825, number: 225, answer: 1 },
    226: { id: 826, number: 226, answer: 3 },
    227: { id: 827, number: 227, answer: 3 },
    228: { id: 828, number: 228, answer: 4 },
    229: { id: 829, number: 229, answer: 1 },
    230: { id: 830, number: 230, answer: 2 },
    231: { id: 831, number: 231, answer: 2 },
    232: { id: 832, number: 232, answer: 3 },
    233: { id: 833, number: 233, answer: 1 },
    234: { id: 834, number: 234, answer: 2 },
    235: { id: 835, number: 235, answer: 1 },
    236: { id: 836, number: 236, answer: 4 },
    237: { id: 837, number: 237, answer: 1 },
    238: { id: 838, number: 238, answer: 3 },
    239: { id: 839, number: 239, answer: 4 },
    240: { id: 840, number: 240, answer: 2 },
    241: { id: 841, number: 241, answer: 3 },
    242: { id: 842, number: 242, answer: 1 },
    243: { id: 843, number: 243, answer: 1 },
    244: { id: 844, number: 244, answer: 2 },
    245: { id: 845, number: 245, answer: 1 },
    246: { id: 846, number: 246, answer: 1 },
    247: { id: 847, number: 247, answer: 1 },
    248: { id: 848, number: 248, answer: 2 },
    249: { id: 849, number: 249, answer: 1 },
    250: { id: 850, number: 250, answer: 3 },
    251: { id: 851, number: 251, answer: 1 },
    252: { id: 852, number: 252, answer: 1 },
    253: { id: 853, number: 253, answer: 1 },
    254: { id: 854, number: 254, answer: 1 },
    255: { id: 855, number: 255, answer: 3 },
    256: { id: 856, number: 256, answer: 1 },
    257: { id: 857, number: 257, answer: 1 },
    258: { id: 858, number: 258, answer: 1 },
    259: { id: 859, number: 259, answer: 4 },
    260: { id: 860, number: 260, answer: 1 },
    261: { id: 861, number: 261, answer: 1 },
    262: { id: 862, number: 262, answer: 2 },
    263: { id: 863, number: 263, answer: 3 },
    264: { id: 864, number: 264, answer: 1 },
    265: { id: 865, number: 265, answer: 4 },
    266: { id: 866, number: 266, answer: 4 },
    267: { id: 867, number: 267, answer: 3 },
    268: { id: 868, number: 268, answer: 3 },
    269: { id: 869, number: 269, answer: 1 },
    270: { id: 870, number: 270, answer: 2 },
    271: { id: 871, number: 271, answer: 3 },
    272: { id: 872, number: 272, answer: 2 },
    273: { id: 873, number: 273, answer: 4 },
    274: { id: 874, number: 274, answer: 1 },
    275: { id: 875, number: 275, answer: 3 },
    276: { id: 876, number: 276, answer: 1 },
    277: { id: 877, number: 277, answer: 3 },
    278: { id: 878, number: 278, answer: 1 },
    279: { id: 879, number: 279, answer: 3 },
    280: { id: 880, number: 280, answer: 1 },
    281: { id: 881, number: 281, answer: 2 },
    282: { id: 882, number: 282, answer: 1 },
    283: { id: 883, number: 283, answer: 3 },
    284: { id: 884, number: 284, answer: 2 },
    285: { id: 885, number: 285, answer: 1 },
    286: { id: 886, number: 286, answer: 1 },
    287: { id: 887, number: 287, answer: 2 },
    288: { id: 888, number: 288, answer: 3 },
    289: { id: 889, number: 289, answer: 3 },
    290: { id: 890, number: 290, answer: 1 },
    291: { id: 891, number: 291, answer: 3 },
    292: { id: 892, number: 292, answer: 1 },
    293: { id: 893, number: 293, answer: 4 },
    294: { id: 894, number: 294, answer: 2 },
    295: { id: 895, number: 295, answer: 1 },
    296: { id: 896, number: 296, answer: 1 },
    297: { id: 897, number: 297, answer: 4 },
    298: { id: 898, number: 298, answer: 1 },
    299: { id: 899, number: 299, answer: 2 },
    300: { id: 900, number: 300, answer: 4 },
    301: { id: 901, number: 301, answer: 4 },
    302: { id: 902, number: 302, answer: 1 },
    303: { id: 903, number: 303, answer: 3 },
    304: { id: 904, number: 304, answer: 2 },
    305: { id: 905, number: 305, answer: 1 },
    306: { id: 906, number: 306, answer: 4 },
    307: { id: 907, number: 307, answer: 2 },
    308: { id: 908, number: 308, answer: 1 },
    309: { id: 909, number: 309, answer: 3 },
    310: { id: 910, number: 310, answer: 1 },
    311: { id: 911, number: 311, answer: 3 },
    312: { id: 912, number: 312, answer: 3 },
    313: { id: 913, number: 313, answer: 2 },
    314: { id: 914, number: 314, answer: 4 },
    315: { id: 915, number: 315, answer: 3 },
    316: { id: 916, number: 316, answer: 2 },
    317: { id: 917, number: 317, answer: 2 },
    318: { id: 918, number: 318, answer: 1 },
    319: { id: 919, number: 319, answer: 2 },
    320: { id: 920, number: 320, answer: 3 },
    321: { id: 921, number: 321, answer: 1 },
    322: { id: 922, number: 322, answer: 1 },
    323: { id: 923, number: 323, answer: 1 },
    324: { id: 924, number: 324, answer: 3 },
    325: { id: 925, number: 325, answer: 2 },
    326: { id: 926, number: 326, answer: 2 },
    327: { id: 927, number: 327, answer: 3 },
    328: { id: 928, number: 328, answer: 1 },
    329: { id: 929, number: 329, answer: 2 },
    330: { id: 930, number: 330, answer: 3 },
    331: { id: 931, number: 331, answer: 2 },
    332: { id: 932, number: 332, answer: 1 },
    333: { id: 933, number: 333, answer: 2 },
    334: { id: 934, number: 334, answer: 1 },
    335: { id: 935, number: 335, answer: 3 },
    336: { id: 936, number: 336, answer: 4 },
    337: { id: 937, number: 337, answer: 3 },
    338: { id: 938, number: 338, answer: 3 },
    339: { id: 939, number: 339, answer: 1 },
    340: { id: 940, number: 340, answer: 2 },
    341: { id: 941, number: 341, answer: 1 },
    342: { id: 942, number: 342, answer: 2 },
    343: { id: 943, number: 343, answer: 1 },
    344: { id: 944, number: 344, answer: 3 },
    345: { id: 945, number: 345, answer: 1 },
    346: { id: 946, number: 346, answer: 1 },
    347: { id: 947, number: 347, answer: 3 },
    348: { id: 948, number: 348, answer: 2 },
    349: { id: 949, number: 349, answer: 1 },
    350: { id: 950, number: 350, answer: 2 },
    351: { id: 951, number: 351, answer: 2 },
    352: { id: 952, number: 352, answer: 2 },
    353: { id: 953, number: 353, answer: 2 },
    354: { id: 954, number: 354, answer: 2 },
    355: { id: 955, number: 355, answer: 1 },
    356: { id: 956, number: 356, answer: 1 },
    357: { id: 957, number: 357, answer: 2 },
    358: { id: 958, number: 358, answer: 2 },
    359: { id: 959, number: 359, answer: 1 },
    360: { id: 960, number: 360, answer: 1 },
    361: { id: 961, number: 361, answer: 1 },
    362: { id: 962, number: 362, answer: 2 },
    363: { id: 963, number: 363, answer: 2 },
    364: { id: 964, number: 364, answer: 1 },
    365: { id: 965, number: 365, answer: 1 },
    366: { id: 966, number: 366, answer: 2 },
    367: { id: 967, number: 367, answer: 2 },
    368: { id: 968, number: 368, answer: 1 },
    369: { id: 969, number: 369, answer: 2 },
    370: { id: 970, number: 370, answer: 2 },
    371: { id: 971, number: 371, answer: 1 },
    372: { id: 972, number: 372, answer: 3 },
    373: { id: 973, number: 373, answer: 1 },
    374: { id: 974, number: 374, answer: 4 },
    375: { id: 975, number: 375, answer: 1 },
    376: { id: 976, number: 376, answer: 3 },
    377: { id: 977, number: 377, answer: 2 },
    378: { id: 978, number: 378, answer: 3 },
    379: { id: 979, number: 379, answer: 1 },
    380: { id: 980, number: 380, answer: 2 },
    381: { id: 981, number: 381, answer: 1 },
    382: { id: 982, number: 382, answer: 4 },
    383: { id: 983, number: 383, answer: 3 },
    384: { id: 984, number: 384, answer: 3 },
    385: { id: 985, number: 385, answer: 2 },
    386: { id: 986, number: 386, answer: 1 },
    387: { id: 987, number: 387, answer: 2 },
    388: { id: 988, number: 388, answer: 1 },
    389: { id: 989, number: 389, answer: 3 },
    390: { id: 990, number: 390, answer: 3 },
    391: { id: 991, number: 391, answer: 1 },
    392: { id: 992, number: 392, answer: 2 },
    393: { id: 993, number: 393, answer: 1 },
    394: { id: 994, number: 394, answer: 2 },
    395: { id: 995, number: 395, answer: 3 },
    396: { id: 996, number: 396, answer: 2 },
    397: { id: 997, number: 397, answer: 3 },
    398: { id: 998, number: 398, answer: 3 },
    399: { id: 999, number: 399, answer: 1 },
    400: { id: 1000, number: 400, answer: 2 },
    401: { id: 1001, number: 401, answer: 2 },
    402: { id: 1002, number: 402, answer: 2 },
    403: { id: 1003, number: 403, answer: 2 },
    404: { id: 1004, number: 404, answer: 2 },
    405: { id: 1005, number: 405, answer: 2 },
    406: { id: 1006, number: 406, answer: 3 },
    407: { id: 1007, number: 407, answer: 1 },
    408: { id: 1008, number: 408, answer: 3 },
    409: { id: 1009, number: 409, answer: 2 },
    410: { id: 1010, number: 410, answer: 2 },
    411: { id: 1011, number: 411, answer: 2 },
    412: { id: 1012, number: 412, answer: 1 },
    413: { id: 1013, number: 413, answer: 2 },
    414: { id: 1014, number: 414, answer: 2 },
    415: { id: 1015, number: 415, answer: 2 },
    416: { id: 1016, number: 416, answer: 2 },
    417: { id: 1017, number: 417, answer: 2 },
    418: { id: 1018, number: 418, answer: 1 },
    419: { id: 1019, number: 419, answer: 1 },
    420: { id: 1020, number: 420, answer: 2 },
    421: { id: 1021, number: 421, answer: 1 },
    422: { id: 1022, number: 422, answer: 3 },
    423: { id: 1023, number: 423, answer: 1 },
    424: { id: 1024, number: 424, answer: 2 },
    425: { id: 1025, number: 425, answer: 3 },
    426: { id: 1026, number: 426, answer: 1 },
    427: { id: 1027, number: 427, answer: 2 },
    428: { id: 1028, number: 428, answer: 1 },
    429: { id: 1029, number: 429, answer: 2 },
    430: { id: 1030, number: 430, answer: 2 },
    431: { id: 1031, number: 431, answer: 3 },
    432: { id: 1032, number: 432, answer: 1 },
    433: { id: 1033, number: 433, answer: 2 },
    434: { id: 1034, number: 434, answer: 1 },
    435: { id: 1035, number: 435, answer: 2 },
    436: { id: 1036, number: 436, answer: 3 },
    437: { id: 1037, number: 437, answer: 1 },
    438: { id: 1038, number: 438, answer: 2 },
    439: { id: 1039, number: 439, answer: 1 },
    440: { id: 1040, number: 440, answer: 4 },
    441: { id: 1041, number: 441, answer: 3 },
    442: { id: 1042, number: 442, answer: 4 },
    443: { id: 1043, number: 443, answer: 2 },
    444: { id: 1044, number: 444, answer: 3 },
    445: { id: 1045, number: 445, answer: 1 },
    446: { id: 1046, number: 446, answer: 1 },
    447: { id: 1047, number: 447, answer: 3 },
    448: { id: 1048, number: 448, answer: 3 },
    449: { id: 1049, number: 449, answer: 1 },
    450: { id: 1050, number: 450, answer: 3 },
    451: { id: 1051, number: 451, answer: 2 },
    452: { id: 1052, number: 452, answer: 3 },
    453: { id: 1053, number: 453, answer: 1 },
    454: { id: 1054, number: 454, answer: 1 },
    455: { id: 1055, number: 455, answer: 2 },
    456: { id: 1056, number: 456, answer: 2 },
    457: { id: 1057, number: 457, answer: 3 },
    458: { id: 1058, number: 458, answer: 3 },
    459: { id: 1059, number: 459, answer: 1 },
    460: { id: 1060, number: 460, answer: 2 },
    461: { id: 1061, number: 461, answer: 3 },
    462: { id: 1062, number: 462, answer: 3 },
    463: { id: 1063, number: 463, answer: 1 },
    464: { id: 1064, number: 464, answer: 1 },
    465: { id: 1065, number: 465, answer: 1 },
    466: { id: 1066, number: 466, answer: 1 },
    467: { id: 1067, number: 467, answer: 2 },
    468: { id: 1068, number: 468, answer: 2 },
    469: { id: 1069, number: 469, answer: 2 },
    470: { id: 1070, number: 470, answer: 4 },
    471: { id: 1071, number: 471, answer: 1 },
    472: { id: 1072, number: 472, answer: 3 },
    473: { id: 1073, number: 473, answer: 1 },
    474: { id: 1074, number: 474, answer: 3 },
    475: { id: 1075, number: 475, answer: 2 },
    476: { id: 1076, number: 476, answer: 2 },
    477: { id: 1077, number: 477, answer: 3 },
    478: { id: 1078, number: 478, answer: 4 },
    479: { id: 1079, number: 479, answer: 2 },
    480: { id: 1080, number: 480, answer: 4 },
    481: { id: 1081, number: 481, answer: 1 },
    482: { id: 1082, number: 482, answer: 2 },
    483: { id: 1083, number: 483, answer: 4 },
    484: { id: 1084, number: 484, answer: 3 },
    485: { id: 1085, number: 485, answer: 2 },
    486: { id: 1086, number: 486, answer: 1 },
    487: { id: 1087, number: 487, answer: 2 },
    488: { id: 1088, number: 488, answer: 1 },
    489: { id: 1089, number: 489, answer: 4 },
    490: { id: 1090, number: 490, answer: 3 },
    491: { id: 1091, number: 491, answer: 1 },
    492: { id: 1092, number: 492, answer: 2 },
    493: { id: 1093, number: 493, answer: 1 },
    494: { id: 1094, number: 494, answer: 2 },
    495: { id: 1095, number: 495, answer: 2 },
    496: { id: 1096, number: 496, answer: 1 },
    497: { id: 1097, number: 497, answer: 1 },
    498: { id: 1098, number: 498, answer: 2 },
    499: { id: 1099, number: 499, answer: 1 },
    500: { id: 1100, number: 500, answer: 2 },
    501: { id: 1101, number: 501, answer: 2 },
    502: { id: 1102, number: 502, answer: 2 },
    503: { id: 1103, number: 503, answer: 1 },
    504: { id: 1104, number: 504, answer: 3 },
    505: { id: 1105, number: 505, answer: 1 },
    506: { id: 1106, number: 506, answer: 2 },
    507: { id: 1107, number: 507, answer: 1 },
    508: { id: 1108, number: 508, answer: 1 },
    509: { id: 1109, number: 509, answer: 3 },
    510: { id: 1110, number: 510, answer: 2 },
    511: { id: 1111, number: 511, answer: 2 },
    512: { id: 1112, number: 512, answer: 2 },
    513: { id: 1113, number: 513, answer: 1 },
    514: { id: 1114, number: 514, answer: 1 },
    515: { id: 1115, number: 515, answer: 2 },
    516: { id: 1116, number: 516, answer: 1 },
    517: { id: 1117, number: 517, answer: 2 },
    518: { id: 1118, number: 518, answer: 1 },
    519: { id: 1119, number: 519, answer: 2 },
    520: { id: 1120, number: 520, answer: 4 },
    521: { id: 1121, number: 521, answer: 1 },
    522: { id: 1122, number: 522, answer: 2 },
    523: { id: 1123, number: 523, answer: 3 },
    524: { id: 1124, number: 524, answer: 2 },
    525: { id: 1125, number: 525, answer: 1 },
    526: { id: 1126, number: 526, answer: 2 },
    527: { id: 1127, number: 527, answer: 3 },
    528: { id: 1128, number: 528, answer: 3 },
    529: { id: 1129, number: 529, answer: 3 },
    530: { id: 1130, number: 530, answer: 1 },
    531: { id: 1131, number: 531, answer: 3 },
    532: { id: 1132, number: 532, answer: 2 },
    533: { id: 1133, number: 533, answer: 3 },
    534: { id: 1134, number: 534, answer: 1 },
    535: { id: 1135, number: 535, answer: 3 },
    536: { id: 1136, number: 536, answer: 1 },
    537: { id: 1137, number: 537, answer: 4 },
    538: { id: 1138, number: 538, answer: 2 },
    539: { id: 1139, number: 539, answer: 3 },
    540: { id: 1140, number: 540, answer: 2 },
    541: { id: 1141, number: 541, answer: 1 },
    542: { id: 1142, number: 542, answer: 2 },
    543: { id: 1143, number: 543, answer: 1 },
    544: { id: 1144, number: 544, answer: 1 },
    545: { id: 1145, number: 545, answer: 2 },
    546: { id: 1146, number: 546, answer: 2 },
    547: { id: 1147, number: 547, answer: 3 },
    548: { id: 1148, number: 548, answer: 3 },
    549: { id: 1149, number: 549, answer: 2 },
    550: { id: 1150, number: 550, answer: 1 },
    551: { id: 1151, number: 551, answer: 3 },
    552: { id: 1152, number: 552, answer: 2 },
    553: { id: 1153, number: 553, answer: 3 },
    554: { id: 1154, number: 554, answer: 2 },
    555: { id: 1155, number: 555, answer: 2 },
    556: { id: 1156, number: 556, answer: 2 },
    557: { id: 1157, number: 557, answer: 3 },
    558: { id: 1158, number: 558, answer: 4 },
    559: { id: 1159, number: 559, answer: 4 },
    560: { id: 1160, number: 560, answer: 2 },
    561: { id: 1161, number: 561, answer: 3 },
    562: { id: 1162, number: 562, answer: 2 },
    563: { id: 1163, number: 563, answer: 1 },
    564: { id: 1164, number: 564, answer: 2 },
    565: { id: 1165, number: 565, answer: 2 },
    566: { id: 1166, number: 566, answer: 3 },
    567: { id: 1167, number: 567, answer: 3 },
    568: { id: 1168, number: 568, answer: 2 },
    569: { id: 1169, number: 569, answer: 1 },
    570: { id: 1170, number: 570, answer: 1 },
    571: { id: 1171, number: 571, answer: 3 },
    572: { id: 1172, number: 572, answer: 2 },
    573: { id: 1173, number: 573, answer: 3 },
    574: { id: 1174, number: 574, answer: 3 },
    575: { id: 1175, number: 575, answer: 2 },
    576: { id: 1176, number: 576, answer: 2 },
    577: { id: 1177, number: 577, answer: 2 },
    578: { id: 1178, number: 578, answer: 4 },
    579: { id: 1179, number: 579, answer: 3 },
    580: { id: 1180, number: 580, answer: 1 },
    581: { id: 1181, number: 581, answer: 2 },
    582: { id: 1182, number: 582, answer: 3 },
    583: { id: 1183, number: 583, answer: 3 },
    584: { id: 1184, number: 584, answer: 4 },
    585: { id: 1185, number: 585, answer: 1 },
    586: { id: 1186, number: 586, answer: 2 },
    587: { id: 1187, number: 587, answer: 3 },
    588: { id: 1188, number: 588, answer: 2 },
    589: { id: 1189, number: 589, answer: 2 },
    590: { id: 1190, number: 590, answer: 3 },
    591: { id: 1191, number: 591, answer: 1 },
    592: { id: 1192, number: 592, answer: 1 },
    593: { id: 1193, number: 593, answer: 3 },
    594: { id: 1194, number: 594, answer: 1 },
    595: { id: 1195, number: 595, answer: 2 },
    596: { id: 1196, number: 596, answer: 2 },
    597: { id: 1197, number: 597, answer: 2 },
    598: { id: 1198, number: 598, answer: 2 },
    599: { id: 1199, number: 599, answer: 1 },
    600: { id: 1200, number: 600, answer: 2 },
};

/* Hàm tải nội dung file CSV từ URL hoặc file cục bộ */
async function fetchCsvData(source, isLocal = false) {
    try {
        let csvData;
        if (isLocal) {
            // Đọc file cục bộ
            csvData = await fs.readFile(source, 'utf-8');
        } else {
            // Tải file từ URL
            const response = await axios.get(source, {
                responseType: 'text',
                headers: {
                    'Content-Type': 'text/csv',
                    'Accept': 'text/csv'
                }
            });
            if (response.status !== 200) {
                throw new Error(`Không thể tải file CSV từ ${source}. Mã lỗi: ${response.status}`);
            }
            csvData = response.data;
        }
        return csvData;
    } catch (error) {
        console.error('Lỗi khi tải file CSV:', error.message);
        throw error;
    }
}

/* Hàm chuyển dữ liệu CSV thành mảng các object */
function convertCsvToObjects(csvData) {
    return new Promise((resolve, reject) => {
        Papa.parse(csvData, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: false,
            transformHeader: (header) => header.trim().replace(/^"|"$/g, ''),
            transform: (value, header) => {
                let cleaned = value.trim().replace(/^"|"$/g, '');
                if (['id', 'numberofquestion', 'threshold', 'IDrank', 'showsubject', 'timeFinish', 'IDSubject', 'IDTest', 'IDQuestion', 'numberquestion', 'order'].includes(header)) {
                    return cleaned === '' || cleaned === 'NULL' ? null : Number(cleaned);
                }
                if (['createdAt', 'updatedAt'].includes(header)) {
                    return cleaned === '' || cleaned === 'NULL' ? null : new Date(cleaned);
                }
                return cleaned === '' || cleaned === 'NULL' ? null : cleaned;
            },
            complete: (results) => {
                const cleanedData = results.data.map(row => {
                    const cleanedRow = {};
                    Object.keys(row).forEach(key => {
                        cleanedRow[key] = row[key] === '' || row[key] === 'NULL' ? null : row[key];
                    });
                    return cleanedRow;
                });
                resolve(cleanedData);
            },
            error: (err) => {
                console.error('Lỗi khi phân tích CSV:', err);
                reject(err);
            }
        });
    });
}

/* Hàm xử lý dữ liệu CSV và tạo mảng các bài kiểm tra */
async function processCsv(source, isLocal = false) {
    try {
        // Tải dữ liệu CSV
        const csvData = await fetchCsvData(source, isLocal);
        // Chuyển dữ liệu CSV thành mảng các object
        const csvRows = await convertCsvToObjects(csvData);

        // Nhóm dữ liệu theo IDTest
        const testsMap = new Map();
        csvRows.forEach(row => {
            const testId = row.IDTest;
            if (!testsMap.has(testId)) {
                testsMap.set(testId, {
                    id: testId,
                    IDSubject: row.IDSubject,
                    code: row.code,
                    questions: []
                });
            }
            const test = testsMap.get(testId);
            const questionNumber = row.numberquestion;
            const questionData = questionsByNumber[questionNumber] ;
            if (questionData) {
                test.questions.push({
                    id: questionData.id,
                    number: questionData.number,
                    URLImage: null, // Không có trong questionsByNumber, giữ null
                    answer: questionData.answer,
                    test_question: {
                        numberquestion: row.numberquestion,
                        IDTest: row.IDTest,
                        IDQuestion: row.IDQuestion,
                        IDSubject: row.IDSubject,
                        order: row.order,
                        IDsubject: row.IDsubject
                    }
                });
            }
        });
        console.log('check testsMap.values()', testsMap.values())
        // Tạo mảng các bài kiểm tra
        const testsArray = Array.from(testsMap.values()).map(test => {
            // Tìm thông tin môn học từ arraySubjects
            const subject = arraySubjects.find(s => s.id === test.IDSubject) || {};
            return {
                id: test.id,
                IDSubject: test.IDSubject,
                code: test.code,
                createdAt: test.createdAt,
                updatedAt: test.updatedAt,
                subject: {
                    id: subject.id,
                    name: subject.name,
                    numberofquestion: subject.numberofquestion,
                    threshold: subject.threshold,
                    IDrank: subject.IDrank,
                    nameEx: subject.nameEx,
                    showsubject: subject.showsubject,
                    timeFinish: subject.timeFinish,
                    createdAt: test.createdAt, // Sử dụng từ CSV nếu không có trong subject
                    updatedAt: test.updatedAt
                },
                questions: test.questions.sort((a, b) => a.test_question.order - b.test_question.order)
            };
        });

        return testsArray;
    } catch (error) {
        console.error('Lỗi khi xử lý CSV:', error.message);
        throw error;
    }
}

/* Hàm ghi dữ liệu vào file cục bộ */
async function writeDataToFile(data, filePath) {
    try {
        const jsonData = JSON.stringify(data, null, 2); // Chuyển đổi dữ liệu thành chuỗi JSON
        await fs.writeFile(filePath, jsonData, 'utf-8');
        console.log(`Dữ liệu đã được ghi vào file: ${filePath}`);
    } catch (error) {
        console.error('Lỗi khi ghi dữ liệu vào file:', error.message);
        throw error;
    }
}

/* Thực thi xử lý CSV */
async function main() {
    // Đường dẫn file CSV
    const csvSource = 'C:/Users/khavy/OneDrive/Desktop/test_Code/abc.csv'; // File cục bộ
    // const csvSource = 'https://example.com/abc.csv'; // Hoặc URL
    const outputFilePath = 'C:/Users/khavy/OneDrive/Desktop/test_Code/output.json'; // Đường dẫn file xuất ra
    
    try {
        const result = await processCsv(csvSource, true); // true nếu là file cục bộ
        await writeDataToFile(result, outputFilePath); // Ghi dữ liệu đã xử lý vào file
    } catch (err) {
        console.error('Xử lý thất bại:', err.message);
    }
}

main();